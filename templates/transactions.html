{% extends 'layout.html' %}
{% block content %}

<style>
  .table.table-striped.table-bordered.align-middle {
    table-layout: fixed;
    width: 100%;
    margin: 0;
  }
  .table thead th {
    text-align: center !important;
  }
  .table.table-striped.table-bordered.align-middle th,
  .table.table-striped.table-bordered.align-middle td {
    padding: 0.5rem !important;
    vertical-align: top;
  }
  .text-col {
    width: 45%;
    word-wrap: break-word;
    overflow-wrap: break-word;
    margin: 0 !important;
  }
  .amount-col {
    width: 20%;
    text-align: center;
    white-space: nowrap;
    margin: 0 !important;
    font-weight: bold;
  }
  .date-cat-assign-col {
    width: 35%;
    word-wrap: break-word;
    overflow-wrap: break-word;
    margin: 0 !important;
  }
  .dropdown-menu {
    max-width: 300px;
    white-space: normal;
    overflow-wrap: break-word;
  }
  .assign-btn {
    margin: 0 !important;
  }
  .list-badge {
    margin-right: 4px;
  }
</style>

<h2>Transactions</h2>

<!-- Global expense stats -->
<div class="mb-3">
  <strong>Total expenses:</strong> {{ "%.2f"|format(total) }} €<br>
  <strong>Refundable expenses:</strong> {{ "%.2f"|format(refundable) }} €<br>
  <strong>Total after refunds:</strong> {{ "%.2f"|format(after_refund) }} €
</div>

<!-- Sorting form -->
<form action="{{ url_for('view_transactions') }}" method="GET" class="mb-3" style="margin:0;padding:0;">
  <label>Sort by:</label>
  <select name="sort" class="form-select d-inline-block" style="width:auto;">
    <option value="highest" {% if sort_mode=='highest' %}selected{% endif %}>Highest Amount</option>
    <option value="lowest" {% if sort_mode=='lowest' %}selected{% endif %}>Lowest Amount</option>
    <option value="latest_date" {% if sort_mode=='latest_date' %}selected{% endif %}>Latest Date</option>
    <option value="oldest_date" {% if sort_mode=='oldest_date' %}selected{% endif %}>Oldest Date</option>
  </select>
  <button class="btn btn-sm btn-primary">Apply</button>
</form>

<!-- Re-classify button -->
<form method="POST" action="{{ url_for('classify_all_transactions') }}" style="margin:0;padding:0;">
  <button type="submit" class="btn btn-warning mb-3">Re-Classify All</button>
</form>

<div class="table-responsive" style="margin:0;padding:0;">
  <table class="table table-striped table-bordered align-middle">
    <thead>
      <tr>
        <th style="display:none;">#</th>
        <th class="text-col">Text</th>
        <th class="amount-col">€</th>
        <th class="date-cat-assign-col">Data</th>
      </tr>
    </thead>
    <tbody>
      {% for trx, cat_name, cat_color, idx in transactions_data %}
      <tr>
        <!-- Hidden index -->
        <td style="display:none;">{{ idx }}</td>

        <!-- Text column -->
        <td class="text-col">
          <div>
            {{ trx['Buchungstext'] }} / {{ trx['Umsatztext'] }}
            <br>
            <small>{{ trx['Name des Partners'] }}</small>
          </div>
        </td>

        <!-- Amount (centered & bold due to CSS) -->
        <td class="amount-col">
          {{ "%.2f"|format(trx['Betrag']) }}
        </td>

        <!-- Combined date + category + assign -->
        <td class="date-cat-assign-col">
          <!-- 1) Date -->
          <div>
            {% if trx['Buchungsdatum'] and '-' in trx['Buchungsdatum'] %}
              {% set parts = trx['Buchungsdatum'].split('-') %}
              {% if parts|length == 3 %}
                {{ parts[2] }}.{{ parts[1] }}.{{ parts[0] }}
              {% else %}
                {{ trx['Buchungsdatum'] }}
              {% endif %}
            {% else %}
              {{ trx['Buchungsdatum'] }}
            {% endif %}
          </div>

          <!-- 2) Category name (with color background) -->
          <div id="catLabel{{ idx }}" style="background-color: {{ cat_color }}; display: inline-block; padding:0 4px;">
            {{ cat_name }}
          </div>

          <!-- 2.1) Existing Lists (Badges) that include this transaction -->
          <div class="mt-1" id="listBadges{{ idx }}">
            {% for lst in lists_data %}
              {% if idx in lst['transaction_ids'] %}
              <span class="badge bg-secondary list-badge" id="listBadge{{ idx }}-{{ lst['id'] }}">
                [L] {{ lst['name'] }}
              </span>
              {% endif %}
            {% endfor %}
          </div>

          <!-- 3) Assign dropdown (Category + List) -->
          <div class="dropdown mt-1">
            <button class="btn btn-sm btn-outline-secondary dropdown-toggle assign-btn"
                    type="button" data-bs-toggle="dropdown">
              <span class="navbar-toggler-icon"></span>
              Assign
            </button>
            <ul class="dropdown-menu p-2">
              <!-- Assign or Unassign Category -->
              <li class="mb-2">
                <strong>Category:</strong>
                <div class="d-flex flex-wrap mt-1" style="gap: 4px;">
                  {% for cat in categories %}
                  <button class="btn btn-sm btn-outline-dark"
                          type="button"
                          style="color: {{ cat['color'] }};"
                          onclick="assignCategoryAjax({{ idx }}, {{ cat['id'] }}, '{{ cat['name'] }}', '{{ cat['color'] }}')">
                    {{ cat['name'] }}
                  </button>
                  {% endfor %}
                  <!-- Additional "Unassign" button for category -->
                  <button class="btn btn-sm btn-danger mt-1"
                          type="button"
                          onclick="unassignCategoryAjax({{ idx }})">
                    Unassign
                  </button>
                </div>
              </li>

              <li><hr class="dropdown-divider"/></li>

              <!-- Assign or Unassign from List -->
              <li>
                <strong>List:</strong>
                <div class="d-flex flex-wrap mt-1" style="gap: 4px;">
                  {% for lst in lists_data %}
                  <div>
                    <!-- "Add" to list -->
                    <button class="btn btn-sm btn-outline-dark mb-1"
                            type="button"
                            onclick="addToListAjax({{ idx }}, {{ lst['id'] }}, '{{ lst['name'] }}')">
                      +{{ lst['name'] }}
                    </button>
                    <!-- "Unassign" from this list -->
                    <!-- If user wants to remove, call removeFromListAjax(...) -->
                    <button class="btn btn-sm btn-danger mb-1"
                            type="button"
                            onclick="removeFromListAjax({{ idx }}, {{ lst['id'] }}, '{{ lst['name'] }}')">
                      -{{ lst['name'] }}
                    </button>
                  </div>
                  {% endfor %}
                </div>
              </li>
            </ul>
          </div>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<script>
function showMessage(msg) {
  alert(msg); // or do something more fancy
}

/** Assign category (already in your code) */
function assignCategoryAjax(trxIndex, catId, catName, catColor) {
  const payload = { trx_index: trxIndex, cat_id: catId };
  fetch("{{ url_for('ajax_assign_category') }}", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  })
  .then(r => r.json())
  .then(resp => {
    if(resp.status === "ok") {
      showMessage(resp.message);
      const catLabel = document.getElementById("catLabel" + trxIndex);
      if(catLabel) {
        catLabel.innerText = catName;
        catLabel.style.backgroundColor = catColor;
      }
    } else {
      showMessage("Error: " + resp.message);
    }
  })
  .catch(err => {
    showMessage("AJAX error: " + err);
  });
}

/** Unassign category => sets transaction's category to None/UNK */
function unassignCategoryAjax(trxIndex) {
  const payload = { trx_index: trxIndex };
  fetch("/ajax/unassign_category", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  })
  .then(r=>r.json())
  .then(resp=>{
    if(resp.status==="ok"){
      showMessage(resp.message);
      const catLabel = document.getElementById("catLabel"+trxIndex);
      if(catLabel){
        catLabel.innerText = "UNK";
        catLabel.style.backgroundColor = "#dddddd";
      }
    } else {
      showMessage("Error: " + resp.message);
    }
  })
  .catch(err=> showMessage("AJAX error: " + err));
}

/** Add transaction to a list (already in your code) */
function addToListAjax(trxIndex, listId, listName) {
  const payload = { trx_index: trxIndex, list_id: listId };
  fetch("/ajax/add_trx_to_list", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  })
  .then(r=>r.json())
  .then(resp=>{
    if(resp.status==="ok"){
      showMessage(resp.message);
      if(resp.added){
        // create new badge in #listBadges if it isn't already there
        const badgesDiv = document.getElementById("listBadges"+trxIndex);
        if(badgesDiv){
          // If not present, add it
          let existingBadge = document.getElementById(`listBadge${trxIndex}-${listId}`);
          if(!existingBadge) {
            const span = document.createElement("span");
            span.className = "badge bg-secondary list-badge";
            span.id = `listBadge${trxIndex}-${listId}`;
            span.innerHTML = `[L] ${listName}`;
            badgesDiv.appendChild(span);
          }
        }
      }
    } else {
      showMessage("Error: " + resp.message);
    }
  })
  .catch(err=> showMessage("AJAX error: " + err));
}

/** Remove transaction from a list => remove the badge from DOM */
function removeFromListAjax(trxIndex, listId, listName) {
  const payload = { trx_index: trxIndex, list_id: listId };
  fetch("/ajax/remove_trx_from_list", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  })
  .then(r=>r.json())
  .then(resp=>{
    if(resp.status==="ok"){
      showMessage(resp.message);
      if(resp.removed){
        // remove the badge from DOM
        const badgeElem = document.getElementById(`listBadge${trxIndex}-${listId}`);
        if(badgeElem) {
          badgeElem.remove();
        }
      }
    } else {
      showMessage("Error: " + resp.message);
    }
  })
  .catch(err=> showMessage("AJAX error: " + err));
}
</script>

{% endblock %}
