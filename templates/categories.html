{% extends 'layout.html' %}
{% block content %}

<!-- 
  A fixed container for AJAX success messages. 
  We'll set display:none by default, then show/hide it with JS.
-->
<div id="ajaxMsgBox"
     style="display:none; position: fixed; top: 10px; right: 10px; z-index: 9999;"
     class="alert alert-success">
</div>

<h2>Categories & Groups</h2>

<!-- Export JSON on one line, Import JSON on the next line -->
<div class="mb-3">
  <!-- Export JSON -->
  <div class="mb-2">
    <a href="{{ url_for('export_categories') }}" class="btn btn-success">
      Export as JSON
    </a>
  </div>

  <!-- Import JSON -->
  <div>
    <form action="{{ url_for('import_categories') }}" method="POST" enctype="multipart/form-data">
      <label for="categories_json" class="form-label me-2">Import JSON:</label>
      <input type="file" id="categories_json" name="categories_json" accept=".json" required>
      <button type="submit" class="btn btn-secondary">Import</button>
    </form>
  </div>
</div>

<!-- Organized by groups -->
{% for g_id, obj in group_map.items() %}
  <h4 class="mt-3">{{ obj.group['name'] }} (Group ID: {{ obj.group['id'] }})</h4>
  <div class="ms-3">
    {% for cat in obj.categories %}
    <!-- Single category block -->
    <div class="border p-2 mb-2" id="catContainer{{ cat['id'] }}">
      <div class="d-flex align-items-center justify-content-between">
        <div>
          <strong id="catNameDisplay{{ cat['id'] }}">{{ cat['name'] }}</strong>
          (ID: {{ cat['id'] }})
          <!-- color swatch -->
          <span class="ms-2"
                id="catColorSwatch{{ cat['id'] }}"
                style="background-color: {{ cat['color'] }}; padding: 0 10px;">
            {{ cat['color'] }}
          </span>
        </div>
        <div>
          <!-- "View Transactions" button -->
          <a href="{{ url_for('view_category_transactions', cat_id=cat['id']) }}"
             class="btn btn-sm btn-info">
            View Transactions
          </a>

          <!-- Hamburger for category actions -->
          <div class="dropdown d-inline-block ms-1">
            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button"
                    data-bs-toggle="dropdown">
              <span class="navbar-toggler-icon"></span>
            </button>
            <ul class="dropdown-menu p-3" style="min-width: 280px;">
              <!-- Rename -->
              <li class="mb-3">
                <label>Rename:</label>
                <input type="text" class="form-control form-control-sm"
                       id="catName{{ cat['id'] }}"
                       value="{{ cat['name'] }}">
                <button class="btn btn-sm btn-outline-success mt-1"
                        onclick="ajaxRenameCat({{cat['id']}})">
                  Save
                </button>
              </li>

              <!-- Update color -->
              <li class="mb-3">
                <label>Update Color:</label>
                <input type="color" class="form-control form-control-color"
                       id="catColor{{ cat['id'] }}"
                       value="{{ cat['color'] }}">
                <button class="btn btn-sm btn-outline-primary mt-1"
                        onclick="ajaxUpdateCatColor({{cat['id']}})">
                  Update
                </button>
              </li>

              <!-- Toggle "Show as Group" -->
              <li class="mb-3">
                <label>Toggle Show-as-Group:</label>
                <button class="btn btn-sm 
                  {% if cat.get('show_up_as_group') %}btn-warning{% else %}btn-outline-warning{% endif %}"
                  onclick="ajaxToggleShowGroup({{cat['id']}})">
                  {% if cat.get('show_up_as_group') %}
                    Disable
                  {% else %}
                    Enable
                  {% endif %}
                </button>
              </li>

              <!-- Assign Group -->
              <li class="mb-3">
                <label>Assign Group:</label>
                <select id="catGroup{{cat['id']}}" class="form-select form-select-sm">
                  <option value="">-- None --</option>
                  {% for g in groups %}
                  <option value="{{ g['id'] }}"
                    {% if cat['group_id'] == g['id'] %}selected{% endif %}>
                    {{ g['name'] }}
                  </option>
                  {% endfor %}
                </select>
                <button class="btn btn-sm btn-outline-secondary mt-1"
                        onclick="ajaxAssignGroup({{cat['id']}})">
                  Set
                </button>
              </li>

              <!-- Rules -->
              <li class="mb-3">
                <label>Rules:</label>
                <div id="catRules{{ cat['id'] }}">
                  {% for rule in cat['rules'] %}
                  <span class="badge bg-info text-dark me-1 mb-1">
                    {{ rule }}
                    <button class="btn-close btn-close-white ms-1"
                            style="float:right;"
                            onclick="ajaxRemoveRule({{cat['id']}}, '{{rule}}')">
                    </button>
                  </span>
                  {% endfor %}
                </div>
                <div class="input-group input-group-sm mt-1" style="max-width: 200px;">
                  <input type="text" id="ruleWord{{cat['id']}}" class="form-control" placeholder="Add rule...">
                  <button class="btn btn-secondary"
                          onclick="ajaxAddRule({{cat['id']}})">
                    Add
                  </button>
                </div>
              </li>

              <li><hr class="dropdown-divider"></li>

              <!-- Delete category -->
              <li>
                <button class="btn btn-sm btn-danger"
                        onclick="ajaxDeleteCategory({{cat['id']}})">
                  Delete Category
                </button>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
{% endfor %}

<h4 class="mt-4">(No Group)</h4>
<div class="ms-3">
  {% for cat in no_group_cats %}
  <div class="border p-2 mb-2" id="catContainer{{ cat['id'] }}">
    <div class="d-flex align-items-center justify-content-between">
      <div>
        <strong id="catNameDisplay{{ cat['id'] }}">{{ cat['name'] }}</strong>
        (ID: {{ cat['id'] }})
        <span class="ms-2"
              id="catColorSwatch{{ cat['id'] }}"
              style="background-color: {{ cat['color'] }}; padding: 0 10px;">
          {{ cat['color'] }}
        </span>
      </div>
      <div>
        <a href="{{ url_for('view_category_transactions', cat_id=cat['id']) }}"
           class="btn btn-sm btn-info">
          View Transactions
        </a>

        <!-- Category actions hamburger -->
        <div class="dropdown d-inline-block ms-1">
          <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button"
                  data-bs-toggle="dropdown">
            <span class="navbar-toggler-icon"></span>
          </button>
          <ul class="dropdown-menu p-3" style="min-width: 280px;">
            <!-- Rename -->
            <li class="mb-3">
              <label>Rename:</label>
              <input type="text" class="form-control form-control-sm"
                     id="catName{{ cat['id'] }}"
                     value="{{ cat['name'] }}">
              <button class="btn btn-sm btn-outline-success mt-1"
                      onclick="ajaxRenameCat({{cat['id']}})">
                Save
              </button>
            </li>

            <!-- Update color -->
            <li class="mb-3">
              <label>Update Color:</label>
              <input type="color" class="form-control form-control-color"
                     id="catColor{{ cat['id'] }}"
                     value="{{ cat['color'] }}">
              <button class="btn btn-sm btn-outline-primary mt-1"
                      onclick="ajaxUpdateCatColor({{cat['id']}})">
                Update
              </button>
            </li>

            <!-- Toggle "Show as Group" -->
            <li class="mb-3">
              <label>Toggle Show-as-Group:</label>
              <button class="btn btn-sm 
                {% if cat.get('show_up_as_group') %}btn-warning{% else %}btn-outline-warning{% endif %}"
                onclick="ajaxToggleShowGroup({{cat['id']}})">
                {% if cat.get('show_up_as_group') %}
                  Disable
                {% else %}
                  Enable
                {% endif %}
              </button>
            </li>

            <!-- Assign group -->
            <li class="mb-3">
              <label>Assign Group:</label>
              <select id="catGroup{{cat['id']}}" class="form-select form-select-sm">
                <option value="">-- None --</option>
                {% for g in groups %}
                <option value="{{ g['id'] }}"
                  {% if cat['group_id'] == g['id'] %}selected{% endif %}>
                  {{ g['name'] }}
                </option>
                {% endfor %}
              </select>
              <button class="btn btn-sm btn-outline-secondary mt-1"
                      onclick="ajaxAssignGroup({{cat['id']}})">
                Set
              </button>
            </li>

            <!-- Rules -->
            <li class="mb-3">
              <label>Rules:</label>
              <div id="catRules{{ cat['id'] }}">
                {% for rule in cat['rules'] %}
                <span class="badge bg-info text-dark me-1 mb-1">
                  {{ rule }}
                  <button class="btn-close btn-close-white ms-1"
                          style="float:right;"
                          onclick="ajaxRemoveRule({{cat['id']}}, '{{rule}}')">
                  </button>
                </span>
                {% endfor %}
              </div>
              <div class="input-group input-group-sm mt-1" style="max-width: 200px;">
                <input type="text" id="ruleWord{{cat['id']}}" class="form-control" placeholder="Add rule...">
                <button class="btn btn-secondary"
                        onclick="ajaxAddRule({{cat['id']}})">
                  Add
                </button>
              </div>
            </li>

            <li><hr class="dropdown-divider"></li>

            <!-- Delete category -->
            <li>
              <button class="btn btn-sm btn-danger"
                      onclick="ajaxDeleteCategory({{cat['id']}})">
                Delete Category
              </button>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </div>
  {% endfor %}
</div>

{% if uncategorized_count > 0 %}
  <h4 class="mt-4">(Uncategorized)</h4>
  <div class="ms-3 d-flex align-items-center">
    <p class="text-muted mb-0 me-3">
      Transactions with no category: {{ uncategorized_count }}
    </p>
    <!-- New "View Transactions" button -->
    <a href="{{ url_for('view_unassigned_transactions') }}" class="btn btn-sm btn-warning">
      View Transactions
    </a>
  </div>
{% endif %}

<hr>
<h3>Create New Category</h3>
<form action="{{ url_for('create_category') }}" method="POST">
  <div class="mb-3">
    <label for="cat_name" class="form-label">Name</label>
    <input type="text" class="form-control" name="category_name" id="cat_name" required>
  </div>
  <div class="mb-3">
    <label for="cat_color" class="form-label">Color</label>
    <input type="color" class="form-control form-control-color" 
           name="category_color" id="cat_color"
           value="#ffffff" title="Choose your color">
  </div>
  <button type="submit" class="btn btn-primary">Create Category</button>
</form>

<hr>
<h2>Groups</h2>
{% for g in groups %}
<div class="border p-2 mb-2">
  <div class="d-flex align-items-center justify-content-between">
    <div>
      <strong>{{ g['name'] }}</strong> (Group ID: {{ g['id'] }})
      <span class="ms-2" style="background-color: {{ g['color'] }}; padding:0 10px;">
        {{ g['color'] }}
      </span>
    </div>
    <div>
      <a href="{{ url_for('view_group_transactions', group_id=g['id']) }}"
         class="btn btn-sm btn-info">
        View Transactions
      </a>

      <!-- Hamburger for group actions -->
      <div class="dropdown d-inline-block ms-1">
        <button class="btn btn-sm btn-outline-primary dropdown-toggle" type="button"
                data-bs-toggle="dropdown">
          <span class="navbar-toggler-icon"></span>
        </button>
        <ul class="dropdown-menu p-3" style="min-width: 240px;">
          <li class="mb-3">
            <label>Rename Group:</label>
            <input type="text" class="form-control form-control-sm"
                   id="gName{{g['id']}}" value="{{ g['name'] }}">
            <button class="btn btn-sm btn-outline-success mt-1"
                    onclick="ajaxRenameGroup({{g['id']}})">
              Save
            </button>
          </li>
          <li class="mb-3">
            <label>Update Color:</label>
            <input type="color" class="form-control form-control-color"
                   id="gColor{{g['id']}}" value="{{ g['color'] }}">
            <button class="btn btn-sm btn-outline-primary mt-1"
                    onclick="ajaxUpdateGroupColor({{g['id']}})">
              Update
            </button>
          </li>
          <li><hr class="dropdown-divider"></li>
          <li>
            <button class="btn btn-sm btn-danger"
                    onclick="deleteGroup({{ g['id'] }})">
              Delete Group
            </button>
          </li>
        </ul>
      </div>
    </div>
  </div>
</div>
{% endfor %}

<h3>Create New Group</h3>
<form action="{{ url_for('create_group') }}" method="POST">
  <div class="mb-3">
    <label for="group_name" class="form-label">Group Name</label>
    <input type="text" class="form-control" name="group_name" id="group_name" required>
  </div>
  <div class="mb-3">
    <label for="group_color" class="form-label">Color</label>
    <input type="color" class="form-control form-control-color"
           name="group_color" id="group_color" value="#888888"
           title="Choose group color">
  </div>
  <button type="submit" class="btn btn-primary">Create Group</button>
</form>

<hr>
<h2>Lists</h2>
<!-- Show each list in the same "Title / ID / Color / Buttons / Dropdown" style -->

{% for l in lists_data %}
<div class="border p-2 mb-2" id="listContainer{{ l['id'] }}">
  <div class="d-flex align-items-center justify-content-between">
    <div>
      <strong>{{ l['name'] }}</strong> (List ID: {{ l['id'] }})
      <span class="ms-2" style="background-color: {{ l['color'] }}; padding:0 10px;">
        {{ l['color'] }}
      </span>
      {% if l['refund_list'] %}
        <span class="badge bg-warning ms-2">Refund</span>
      {% endif %}
    </div>
    <div>
      <!-- "View Items" button -->
      <a href="{{ url_for('view_list_transactions', list_id=l['id']) }}"
         class="btn btn-sm btn-info">
        View Items
      </a>

      <!-- Hamburger dropdown for lists -->
      <div class="dropdown d-inline-block ms-1">
        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
          <span class="navbar-toggler-icon"></span>
        </button>
        <ul class="dropdown-menu p-3" style="min-width: 280px;">
          <!-- Rename list -->
          <li class="mb-3">
            <label>Rename List:</label>
            <form action="{{ url_for('rename_list', list_id=l['id']) }}" method="POST" class="mt-1">
              <div class="input-group input-group-sm">
                <input type="text" class="form-control" name="new_name" value="{{ l['name'] }}">
                <button class="btn btn-outline-success btn-sm" type="submit">Save</button>
              </div>
            </form>
          </li>

          <!-- Toggle refund -->
          <li class="mb-3">
            <label>Toggle Refund:</label>
            <form action="{{ url_for('toggle_refund_list', list_id=l['id']) }}" method="POST" class="mt-1">
              <button class="btn btn-sm 
                {% if l['refund_list'] %}btn-warning{% else %}btn-outline-warning{% endif %}"
                type="submit">
                {% if l['refund_list'] %} Disable Refund {% else %} Enable Refund {% endif %}
              </button>
            </form>
          </li>

          <!-- Delete list -->
          <li>
            <form action="{{ url_for('delete_list', list_id=l['id']) }}" method="POST">
              <button class="btn btn-sm btn-danger mt-1" type="submit">
                Delete List
              </button>
            </form>
          </li>
        </ul>
      </div>
    </div>
  </div>
</div>
{% endfor %}

<h3>Create New List</h3>
<form action="{{ url_for('create_list') }}" method="POST">
  <div class="mb-3">
    <label for="list_name" class="form-label">List Name</label>
    <input type="text" class="form-control" id="list_name" name="list_name" required>
  </div>
  <div class="mb-3">
    <label for="list_color" class="form-label">Color</label>
    <input type="color" class="form-control form-control-color" id="list_color" name="list_color" value="#0000ff">
  </div>
  <div class="mb-3 form-check">
    <input class="form-check-input" type="checkbox" id="refund_list" name="refund_list" value="1">
    <label class="form-check-label" for="refund_list">Refund List?</label>
  </div>
  <button class="btn btn-primary">Create List</button>
</form>

<hr>
<!-- "Add transaction to a list" and "Remove transaction from a list" forms -->
<h3>Add Transactions to a List</h3>
<form action="{{ url_for('add_trx_to_list') }}" method="POST" class="row g-3 mb-4">
  <div class="col-auto">
    <select name="list_id" class="form-select">
      {% for l in lists_data %}
      <option value="{{ l['id'] }}">{{ l['name'] }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-auto">
    <input type="number" name="trx_index" placeholder="Transaction index" class="form-control" min="0">
  </div>
  <div class="col-auto">
    <button class="btn btn-secondary">Add Transaction</button>
  </div>
</form>

<h3>Remove Transactions from a List</h3>
<form action="{{ url_for('remove_trx_from_list') }}" method="POST" class="row g-3">
  <div class="col-auto">
    <select name="list_id" class="form-select">
      {% for l in lists_data %}
      <option value="{{ l['id'] }}">{{ l['name'] }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-auto">
    <input type="number" name="trx_index" placeholder="Transaction index" class="form-control" min="0">
  </div>
  <div class="col-auto">
    <button class="btn btn-secondary">Remove Transaction</button>
  </div>
</form>

<!-- 
  JS Functions for Groups and Categories (with toasts)
  (Your existing script)
-->
<script>
let toastTimer = null;

/** 
 * Show a green popup (alert) on the top-right with a message.
 * It hides automatically after 3 seconds, or if called again with a new message,
 * it resets the timer.
 */
function showToast(msg) {
  if (toastTimer) {
    clearTimeout(toastTimer);
    toastTimer = null;
  }
  const msgBox = document.getElementById("ajaxMsgBox");
  msgBox.innerText = msg;
  msgBox.style.display = "block";
  msgBox.classList.remove("alert-danger");
  msgBox.classList.add("alert-success");

  toastTimer = setTimeout(() => {
    msgBox.style.display = "none";
    toastTimer = null;
  }, 3000);
}

// ---------- GROUP AJAX -----------
function deleteGroup(gid) {
  if(!confirm("Delete group " + gid + "?")) return;
  fetch("{{ url_for('ajax_delete_group') }}", {
    method: "POST",
    headers: {"Content-Type": "application/x-www-form-urlencoded"},
    body: "group_id="+gid
  })
  .then(r => r.json())
  .then(resp => {
    if(resp.status=="ok") {
      showToast(resp.message);
      setTimeout(() => { location.reload(); }, 1000);
    } else {
      alert(resp.message);
    }
  });
}
function ajaxRenameGroup(gid) {
  let new_name = document.getElementById("gName"+gid).value;
  fetch("{{ url_for('ajax_rename_group') }}", {
    method: "POST",
    headers: {"Content-Type": "application/x-www-form-urlencoded"},
    body: "group_id="+gid+"&new_name="+encodeURIComponent(new_name)
  })
  .then(r => r.json())
  .then(resp=>{
    if(resp.status=="ok"){
      showToast(resp.message);
      // you could reload to update group name in DOM
      // location.reload();
    } else {
      alert(resp.message);
    }
  });
}
function ajaxUpdateGroupColor(gid) {
  let new_color = document.getElementById("gColor"+gid).value;
  fetch("{{ url_for('ajax_update_group_color') }}", {
    method:"POST",
    headers: {"Content-Type":"application/x-www-form-urlencoded"},
    body:"group_id="+gid+"&new_color="+encodeURIComponent(new_color)
  })
  .then(r=>r.json())
  .then(resp=>{
    if(resp.status=="ok"){
      showToast(resp.message);
    } else {
      alert(resp.message);
    }
  });
}

// ---------- CATEGORY AJAX -----------
function ajaxRenameCat(catId) {
  let new_name = document.getElementById('catName' + catId).value;
  fetch("{{ url_for('ajax_rename_category') }}", {
    method:"POST",
    headers: {"Content-Type":"application/x-www-form-urlencoded"},
    body: "cat_id="+catId+"&new_name="+encodeURIComponent(new_name)
  })
  .then(r=>r.json())
  .then(resp=>{
    if(resp.status=="ok"){
      showToast(resp.message);
      document.getElementById('catNameDisplay' + catId).innerText = new_name;
    } else {
      alert(resp.message);
    }
  });
}

function ajaxUpdateCatColor(catId) {
  let c = document.getElementById('catColor' + catId).value;
  fetch("{{ url_for('ajax_update_category_color') }}", {
    method:"POST",
    headers: {"Content-Type":"application/x-www-form-urlencoded"},
    body: "cat_id="+catId+"&new_color="+encodeURIComponent(c)
  })
  .then(r=>r.json())
  .then(resp=>{
    if(resp.status=="ok"){
      showToast(resp.message);
      const swatch = document.getElementById("catColorSwatch" + catId);
      if (swatch) {
        swatch.style.backgroundColor = c;
        swatch.innerText = c;
      }
    } else {
      alert(resp.message);
    }
  });
}

function ajaxToggleShowGroup(catId) {
  fetch("{{ url_for('ajax_toggle_show_group') }}", {
    method:"POST",
    headers: {"Content-Type":"application/x-www-form-urlencoded"},
    body: "cat_id="+catId
  })
  .then(r=>r.json())
  .then(resp=>{
    if(resp.status=="ok"){
      showToast(resp.message);
    } else {
      alert(resp.message);
    }
  });
}

function ajaxAssignGroup(catId) {
  let g = document.getElementById('catGroup' + catId).value;
  fetch("{{ url_for('ajax_assign_group') }}", {
    method:"POST",
    headers: {"Content-Type":"application/x-www-form-urlencoded"},
    body: "cat_id="+catId+"&group_id="+encodeURIComponent(g)
  })
  .then(r=>r.json())
  .then(resp=>{
    if(resp.status=="ok"){
      showToast(resp.message);
      setTimeout(() => { location.reload(); }, 1000);
    } else {
      alert(resp.message);
    }
  });
}

function ajaxAddRule(catId) {
  let r = document.getElementById('ruleWord' + catId).value;
  fetch("{{ url_for('ajax_add_rule') }}", {
    method:"POST",
    headers: {"Content-Type":"application/x-www-form-urlencoded"},
    body:"cat_id="+catId+"&rule_word="+encodeURIComponent(r)
  })
  .then(x=>x.json())
  .then(resp=>{
    if(resp.status=="ok"){
      showToast(resp.message);
      // Optionally update DOM with new rule...
    } else {
      alert(resp.message);
    }
  });
}

function ajaxRemoveRule(catId, rule) {
  fetch("{{ url_for('ajax_remove_rule') }}", {
    method:"POST",
    headers: {"Content-Type":"application/x-www-form-urlencoded"},
    body:"cat_id="+catId+"&rule_word="+encodeURIComponent(rule)
  })
  .then(x=>x.json())
  .then(resp=>{
    if(resp.status=="ok"){
      showToast(resp.message);
      // remove rule badge from DOM if you want
    } else {
      alert(resp.message);
    }
  });
}

function ajaxDeleteCategory(catId) {
  if(!confirm("Delete category ID="+catId+"?")) return;
  fetch("{{ url_for('ajax_delete_category') }}", {
    method:"POST",
    headers: {"Content-Type":"application/x-www-form-urlencoded"},
    body:"cat_id="+catId
  })
  .then(r=>r.json())
  .then(resp=>{
    if(resp.status=="ok"){
      showToast(resp.message);
      // remove container
      const container = document.getElementById("catContainer" + catId);
      if(container) container.remove();
    } else {
      alert(resp.message);
    }
  });
}
</script>
{% endblock %}
